<!DOCTYPE html>
<html>
<head>
    <title>BulkUserUtilityApp</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('CA.technicalservices.userutilities.ListFilterPanel', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.listfilterpanel',

    cls: 'inline-filter-panel',
    flex: 1,
    header: false,
    minHeight: 46,
    padding: '8px 0 0 0',
    bodyPadding: '7px 5px 5px 5px',
    collapseDirection: 'top',
    collapsible: true,
    animCollapse: false,
    stateful: true,
    stateId: 'listFilterPanel',

    constructor: function(config) {
        this.mergeConfig(config);
        this.callParent([this.config]);
    },

    initComponent: function() {
        this.callParent(arguments);

        if (!this.stateful || (this.stateful && !this._hasState())) {
            this.applyState({});
        }

    },
    _hasState: function(){
        if (this.stateful && this.stateId) {
            return !!Ext.state.Manager.get(this.stateId);
        }
        return false;
    },
    //_loadModels: function(state){
    //    if (this.models){
    //        this._addItems(state);
    //        return;
    //    }
    //
    //    if (this.context && this.modelNames && this.modelNames.length > 0){
    //        Rally.data.ModelFactory.getModels({
    //            types: this.modelNames,
    //            context: this.context,
    //            success: function(models){
    //                this.models = models;
    //                this._addItems(state);
    //            },
    //            scope: this
    //        });
    //    }
    //},
    _addItems: function(state){
        if (!state){
            state = {};
        }

        this.removeAll();

        this.add({
            xtype: 'rallybutton',
            cls: 'inline-filter-panel-close icon-cross',
            height: 18,
            userAction: 'Close (X) filter panel clicked',
            listeners: {
                click: function() {
                    this.collapse();
                },
                scope: this
            }
        });

        var users = "";
        if (state.users && state.users.length > 0){
            users = state.users.join(',');
        }
        this.add({
            xtype: 'textarea',
            itemId: 'listBox',
            flex: 1,
            width: '90%',
            emptyText: 'Paste or type comma, space, tab or return delimited field values here...',
            labelAlign: 'top',
            margin: '0 20 5 20',
            fieldLabel: 'Filter UserNames:',
            height: 100,
            autoScroll: true,
            value: users
        });


        this.add({
            xtype: 'container',
            layout: 'hbox',
            items: [{
                xtype: 'rallybutton',
                text: 'Apply',
                margin: '5 5 20 20',
                listeners: {
                    click: this.updateListItems,
                    scope: this
                }
            },{
                xtype: 'rallybutton',
                text: 'Clear',
                margin: '5 5 20 5',
                listeners: {
                    click: this.clearListItems,
                    scope: this
                }
            }]
        });
    },
    clear: function(){
        this._getListBox().setValue('');
    },
    _getListBox: function(){
        return this.down('#listBox');
    },
    getState: function(){
        var currentState = this.getListItems();
        if (currentState.listItems && Ext.isArray(currentState.listItems)){
            currentState.listItems = currentState.listItems.join(',');
        }
        return currentState;
    },
    applyState: function(state){
        if (state && state.listItems && !Ext.isArray(state.listItems)){
            state.listItems = state.listItems.split(',');
        }
        this._addItems(state);
    },
    getListItems: function(){
        var listItems = this._getListBox().getValue();
        if (!listItems || listItems.length === 0){
            return [];
        }
        listItems = listItems.replace(/[,"\s]{1,}/g, ",");
        return listItems.split(',') || [];
    },
    updateListItems: function(){
        this.saveState();
        if (this.getListItems().length > 0){
            this.fireEvent('listitemsupdated', this.getListItems());
        } else {
            this.fireEvent('listitemsupdated', []);
        }
    },
    clearListItems: function(){
        this._getListBox().setValue(null);
        this.updateListItems();
    }

});
                Ext.define('CA.technicalservices.userutilities.FieldPicker', {
    alias: 'widget.fieldpickerbutton',
    extend:'Rally.ui.Button',
    requires: [
        'Rally.ui.popover.Popover',
        'Rally.ui.Button',
        'Rally.ui.picker.FieldPicker',
        'Ext.state.Manager'
    ],
    toolTipConfig: {
        html: 'Show Columns',
        anchor: 'top'
    },
    iconCls: 'icon-add-column',

    cls: 'field-picker-btn secondary rly-small',

    alwaysSelectedValues: ['UserName', 'DisplayName'], // DragAndDropRank gets added in init if Drag and Drop is enabled for the workspace in the component's context

    fieldBlackList: [],

    fieldPickerConfig: {},

    buttonConfig: {},

    modelNames: ['User'],

    rankingEnabled: false,

    margin: '3 9 0 0',

    //This does not show the Rank column

    constructor: function (config) {
        this.config = _.merge({}, this.config || {}, config || {});
        this.callParent([config]);
    },

    initComponent: function() {

        if (this.models){
            this.on('click', this._createPopover, this);
            this.callParent(arguments);
            return;
        }

        if (this.context && this.modelNames && this.modelNames.length > 0){
            Rally.data.ModelFactory.getModels({
                types: this.modelNames,
                context: this.context,
                success: function(models){
                    console.log('models');
                    this.models = models;

                },
                failure: function(failedParam){
                    console.log('failedparam');
                },
                scope: this
            });
            this.on('click', this._createPopover, this);
        } else {
            this.iconCls = 'icon-none';
            var msg = "Please update the CA.technicalservices.FieldPicker configuration with modelNames and context";
            this.toolTipConfig= {
                html: '<div style="color:red;">' + msg + '</div>'
            }
            this.on('click', function(){ Rally.ui.notify.Notifier.showError({message: msg})})
        }
        this.callParent(arguments);
    },
    getFields: function(){
        return this._fields || this.alwaysSelectedValues;
    },
    _getPickerConfig: function() {
        var pickerConfig;
        pickerConfig = _.extend({
            value: this._fields,
            fieldBlackList: this.fieldBlackList,
            alwaysSelectedValues: this.alwaysSelectedValues,
            context: this.context
        }, this.fieldPickerConfig);

        return pickerConfig;
    },

    _createPopover: function(btn) {
        var popoverTarget = btn.getEl();

        this.popover = Ext.create('Rally.ui.popover.Popover', {
            target: popoverTarget,
            placement: ['bottom', 'left', 'top', 'right'],
            cls: 'field-picker-popover',
            toFront: Ext.emptyFn,
            buttonAlign: 'center',
            title: this.getTitle(),
            listeners: {
                destroy: function () {
                    this.popover = null;
                },
                scope: this
            },
            buttons: [
                {
                    xtype: "rallybutton",
                    text: 'Apply',
                    cls: 'field-picker-apply-btn primary rly-small',
                    listeners: {
                        click: function() {
                            this._onApply(this.popover);
                        },
                        scope: this
                    }
                },
                {
                    xtype: "rallybutton",
                    text: 'Cancel',
                    cls: 'field-picker-cancel-btn secondary dark rly-small',
                    listeners: {
                        click: function() {
                            this.popover.close();
                        },
                        scope: this
                    }
                }
            ],
            items: [
                _.extend({
                    xtype: 'rallyfieldpicker',
                    cls: 'field-picker',
                    itemId: 'fieldpicker',
                    modelTypes: this._getModelTypes(),
                    alwaysExpanded: true,
                    width: 200,
                    emptyText: 'Search',
                    selectedTextLabel: 'Selected',
                    availableTextLabel: 'Available',
                    listeners: {
                        specialkey: function(field, e) {
                            if (e.getKey() === e.ESC) {
                                this.popover.close();
                            }
                        },
                        scope: this
                    }
                }, this._getPickerConfig())
            ]
        });
    },

    _getModelTypes: function() {
        return _.pluck(this._getModels(), 'typePath');
    },

    _getModels: function() {
        return _.reduce(this.models, function(accum, model) {
            if (model.typePath === 'artifact') {
                accum = accum.concat(model.getArtifactComponentModels());
            } else {
                accum.push(model);
            }
            return accum;
        }, []);
    },

    getTitle: function () {
        return 'Show Columns';
    },

    /**
     * Update the fields displayed. In grid mode this will be the columns displayed. In board mode it will be
     * the fields on the cards
     *
     * @param {String[]|Object[]} fields A list of field names to display
     * @param {Boolean} true to suspend store load if it will be triggered elsewhere
     */
    updateFields: function (fields, suspendLoad) {
        this._fields = fields;
        if (this.popover && this.popover.down('rallyfieldpicker')) {
            this.popover.down('rallyfieldpicker').setValue(fields.join(','));
        }
        this.saveState();
    },
    getState: function(){
        return {
            fields: this._fields
        };
    },
    applyState: function(state){
        if (state){
            this._fields = state.fields;
        }
    },
    _onApply: function(popover) {
        var fieldPicker = popover.down('rallyfieldpicker'),
            fields = _.map(fieldPicker.getValue(), function (field) {
                return field.get('name');
            });

        this.updateFields(fields);
        popover.close();

        this.fireEvent('fieldsupdated', fields);
    }
});
                Ext.define('CA.technicalservices.userutilities.UserListFilterButton', {
    extend: 'Rally.ui.Button',
    alias: 'widget.listfilterbutton',

    cls: 'secondary rly-small',
    iconCls: 'icon-users',

    stateful: true,
    stateId: 'userListFilterButton',
    stateEvents: ['expand', 'collapse', 'listupdated'],
    text: '',

    config: {
        context: undefined,
        modelNames: undefined,
        toolTipConfig: {
            anchor: 'top',
            mouseOffset: [-9, -2]
        }
    },

    initComponent: function() {
        this.callParent(arguments);

        if (!this.stateful || (this.stateful && !this._hasState())) {
            this.applyState({});
        }

        this.on('click', this._togglePanel, this, { buffer: 200 });
        this.on('listitemsupdated', this._onPanelChange, this, { buffer: 500 });
        this.on('collapse', this._onCollapse, this);
    },
    _hasState: function(){
        if (this.stateful && this.stateId) {
            return !!Ext.state.Manager.get(this.stateId);
        }
        return false;
    },
    _onPanelChange: function(){

        Ext.suspendLayouts();
        if (this.getItems() && this.getItems().length > 0) {
            this.setText(Ext.String.format('{0} List Items',this.getItems().length));
            this._indicateActiveFilterPresent();
        } else {
            this.setText('');
            this._indicateNoActiveFilterPresent();
        }
        Ext.resumeLayouts(false);
        this.fireEvent('listupdated',  this.getItems());
    },
    hasUsers: function(){
        return this.getListItems().length > 0;
    },
    getItems: function(){
        return this.userListPanel && this.userListPanel.getListItems() || [];
    },
    getItemField: function(){
        return 'UserName';
    },
    afterRender: function() {
        this.callParent(arguments);
        this.toolTip.on('beforeshow', this._onBeforeShowToolTip, this);
    },
    getState: function() {
        if (this.userListPanel) {
            var state = this.userListPanel.getListItems();
            state.collapsed = this.userListPanel.getCollapsed();
            return state;
        } else {
            return Ext.state.Manager.get(this.stateId);
        }
    },
    applyState: function(state) {
        //console.log('applyState', state);
        this._build(state);
    },

    onDestroy: function() {
        _.invoke(_.compact([
            this.relayedEvents,
            this.userListPanel
        ]), 'destroy');
        this.callParent(arguments);
    },

    clearAllFilters: function() {
        if (this.userListPanel){
            this.userListPanel.clear();
        }
    },

    _build: function(applyParameters) {
        if (!this.userListPanel){
            this.userListPanel = Ext.widget({
                xtype: 'listfilterpanel',
                context: this.context,
                flex: 1
            });
            this.relayedEvents = this.relayEvents(this.userListPanel, ['expand', 'collapse', 'listitemsupdated','panelresize', 'parametersupdated']);
            this.fireEvent('listready', this.userListPanel);
        }
        if (applyParameters) {
            this._applyParameters();
        }
    },
    _applyParameters: function(){
        // console.log('_applyParameters', params);
    },
    _indicateActiveFilterPresent: function() {
        if (!this.hasCls('primary')) {
            this.addCls('primary');
            this.removeCls('secondary');
        }
    },
    _indicateNoActiveFilterPresent: function() {
        if (!this.hasCls('secondary')) {
            this.addCls('secondary');
            this.removeCls('primary');
        }
    },
    _togglePanel: function() {
        if (this.userListPanel){
            this.userListPanel.toggleCollapse();
        }
    },
    collapse: function() {
        if (this.userListPanel){
            this.userListPanel.collapse();
        }
    },
    _onBeforeShowToolTip: function() {
        var action = this.userListPanel && this.userListPanel.collapsed ? 'Show' : 'Hide' || "Toggle";
        this.toolTip.update(Ext.String.format('{0} User Filter List', action));
    },
    _onCollapse: function() {
        console.log('_onCollapse validate here?');
    },
});
                Ext.define('CA.technicalservices.userutilities.bulkmenu.AssignPermissions', {
    alias: 'widget.assignpermissionsbulkmenuitem',
    extend: 'Rally.ui.menu.bulk.MenuItem',

    config: {
        onBeforeAction: function(){
//            console.log('onbeforeaction');
        },

        /**
         * @cfg {Function} onActionComplete a function called when the specified menu item action has completed
         * @param Rally.data.wsapi.Model[] onActionComplete.successfulRecords any successfully modified records
         * @param Rally.data.wsapi.Model[] onActionComplete.unsuccessfulRecords any records which failed to be updated
         */
        onActionComplete: function(){
            console.log('onActionComplete');
        },

        text: 'Example Menu Item...',

        handler: function () {
            console.log('example menu item clicked');
        },
        predicate: function (records) {
            return _.every(records, function (record) {
                return record;
            });
        }
    }
});
                Ext.override(Rally.ui.grid.CheckboxModel, {
    _recordIsSelectable: function(record) {
        return true;
    }
});

Ext.define('CA.technicalservices.userutilities.UserGrid',{
    extend: 'Rally.ui.grid.Grid',

    config: {
        columnCfgs: [
            'UserName',
            'DisplayName'
        ],
        storeConfig: {
            model: 'User'
        },
        enableBulkEdit: true,
        bulkEditConfig: {
            items: [{
                xtype: 'assignpermissionsbulkmenuitem'
            }]
        }
    },
    constructor: function(config) {
        this.mergeConfig(config);
        this.callParent(arguments);
    }
});


                Ext.define('CA.technicalservices.userutilities.BulkUserUtilityApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    launch: function() {
        this._addBoxes();

        this._addSelectorComponents();

        this.buildGrid();
    },
    _addSelectorComponents: function(){
        this.getSelectorBox().removeAll();

        var fp = this.getSelectorBox().add({
            xtype: 'fieldpickerbutton',
            modelNames: ['User'],
            context: this.getContext(),
            stateful: true,
            stateId: 'grid-columns'
        });
        fp.on('fieldsupdated', this.updateStoreFields, this);

        this.getSelectorBox().add({
            xtype: 'rallyinlinefilterbutton',
            modelNames: ['User'],
            context: this.getContext(),
            margin: '3 9 0 0',
            stateful: true,
            stateId: 'grid-filters-1',
            listeners: {
                inlinefilterready: this.addInlineFilterPanel,
                inlinefilterchange: this.updateGridFilters,
                scope: this
            }
        });

        this.getSelectorBox().add({
            xtype: 'listfilterbutton',
            context: this.getContext(),
            margin: '3 9 0 0',
            listeners: {
                scope: this,
                listready: this.addListFilterPanel,
                listupdated: this.updateGridFilters
            }
        });

    },
    addListFilterPanel: function(panel){
        this.getListFilterBox().add(panel);
    },
    updateStoreFields: function(fields){
        //console.log('updateStoreFields', fields)
        this.getGrid().reconfigureWithColumns(fields);
    },
    updateGridFilters: function(filter){
        console.log('updateGridFilters', filter);
       // this._gridConfig.filters = filter.getTypesAndFilters();
        this.getSelectorBox().doLayout();
        this.buildGrid();
    },
    getFilterListButton: function(){
        return this.down('listfilterbutton');
    },
    getFilters: function(){
        var items = this.getFilterListButton() && this.getFilterListButton().getItems(),
            field = this.getFilterListButton() && this.getFilterListButton().getItemField(),
            filters = null;

        if (items && items.length > 0){
            filters = _.map(items, function(i){
                return {
                    property: field,
                    value: i
                }
            });
            filters = Rally.data.wsapi.Filter.or(filters);
        }

       // var advancedFilters = this.down('rallyinlinefilterbutton').getWsapiFilter();
        var filterButton = this.down('rallyinlinefilterbutton');
        if (filterButton && filterButton.inlineFilterPanel && filterButton.getWsapiFilter()){
            console.log('advancedfilters', filterButton.getWsapiFilter(), filterButton.getFilters());
            if (filters){
                filters = filters.and(filterButton.getWsapiFilter());
            } else {
                filters = filterButton.getWsapiFilter();
            }

        }
        return filters || [];
    },
    addInlineFilterPanel: function(panel){
        this.getAdvancedFilterBox().add(panel);
    },
    buildGrid: function(){
        this.getGridBox().removeAll();

        var grid = Ext.create('CA.technicalservices.userutilities.UserGrid',{
            columnCfgs: this.down('fieldpickerbutton').getFields() || undefined,
            storeConfig: {
                filters: this.getFilters(),
                enablePostGet: false
            }
        });
        this.getGridBox().add(grid);
    },
    _addBoxes: function(){
        this.removeAll();

        this.add({
            xtype: 'container',
            itemId: 'selectorBox',
            layout: 'hbox'
        });

        this.add({
            xtype:'container',
            itemId: 'advancedFilterBox',
            flex: 1
        });

        this.add({
            xtype:'container',
            itemId: 'listFilterBox',
            flex: 1
        });

        this.add({
            xtype:'container',
            itemId: 'gridBox'
        });
    },
    getGrid: function(){
        return this.down('rallygrid');
    },
    getGridBox: function(){
        return this.down('#gridBox');
    },
    getSelectorBox: function(){
        return this.down('#selectorBox');
    },
    getListFilterBox: function(){
        return this.down('#listFilterBox');
    },
    getAdvancedFilterBox: function(){
        return this.down('#advancedFilterBox');
    },
    showErrorNotification: function(msg){
        Rally.ui.notify.Notifier.showError({message: msg });
    }
});


            Rally.launchApp('CA.technicalservices.userutilities.BulkUserUtilityApp', {
                name:"BulkUserUtilityApp",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
